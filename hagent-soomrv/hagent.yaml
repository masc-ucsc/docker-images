profiles:
  - name: soomrv
    description: "Build and test SoomRV processor with Verilator simulation"
    memory: 8
    configuration:
      source: "track_repo_dir('src', ext='.sv')"
      source: "track_repo_dir('hardfloat', ext='.v')"
      output: "track_build_dir('obj_dir')"
      environment:
        SOOMRV_HOME: "/code/workspace/repo"
    apis:
      - name: build
        description: "Build SoomRV Verilator simulation binary"
        command: "make"
        cwd: "$HAGENT_REPO_DIR"
      - name: build_with_trace
        description: "Build SoomRV with VCD trace support"
        command: "make trace"
        cwd: "$HAGENT_REPO_DIR"
      - name: isa_tests
        description: "Run quick ISA test suite"
        command: "python3 scripts/test_suite.py /opt/riscv-tests/isa"
        cwd: "$HAGENT_REPO_DIR"
      - name: system_regression
        description: "Run full-system regression suite (CoreMark, Dhrystone, Linux boot)"
        command: |
          ./obj_dir/VTop test_programs/coremark.elf 1> >(tee logs/coremark.out) 2> >(tee logs/coremark.err) && \
          ./obj_dir/VTop test_programs/dhry_1_O3_no_inline.s 1> >(tee logs/dhry_1_O3_no_inline.out) 2> >(tee logs/dhry_1_O3_no_inline.err) && \
          ./obj_dir/VTop test_programs/dhry_1_O3.s 1> >(tee logs/dhry_1_O3.out) 2> >(tee logs/dhry_1_O3.err) && \
          ./obj_dir/VTop test_programs/dhry_1_O3_inline.s 1> >(tee logs/dhry_1_O3_inline.out) 2> >(tee logs/dhry_1_O3_inline.err) && \
          (timeout 3600 ./obj_dir/VTop test_programs/linux/linux_image.elf \
            --device-tree=test_programs/linux/device_tree.dtb --perfc \
            1> >(tee logs/linux.out) 2> >(tee logs/linux.err) || { [ $? -eq 124 ] && exit 0; exit $?; })
        cwd: "$HAGENT_REPO_DIR"
      - name: single_test
        description: "Run single Dhrystone test as example"
        command: "./obj_dir/VTop test_programs/dhry_1.s"
        cwd: "$HAGENT_REPO_DIR"
      - name: bitmanip
        description: "Run single B-extension test"
        command: "./obj_dir/VTop test_programs/bitmanip.s"
        cwd: "$HAGENT_REPO_DIR"
      - name: synth_asic
        description: "ASIC synthesis using Yosys"
        command: |
          /code/hagent/scripts/synth.py --sv2v --sta {{top}} {{top_synth}} --netlist ${HAGENT_BUILD_DIR}/netlist.v \
          src/lib/PriorityEncoder.sv \
          src/lib/OHEncoder.sv \
          src/lib/RangeMaskGen.sv \
          src/lib/PrefixSum.sv \
          src/lib/PrefixRed.sv \
          src/lib/OpDownsample.sv \
          src/lib/PopCnt.sv \
          src/lib/FIFO.sv \
          src/Config.sv \
          src/Include.sv  \
          src/InstrDecoder.sv  \
          src/Rename.sv  \
          src/Core.sv  \
          src/IssueQueue.sv  \
          src/IntALU.sv  \
          src/IFetch.sv \
          src/Load.sv \
          src/ROB.sv \
          src/AGU.sv \
          src/BranchPredictor.sv \
          src/LoadBuffer.sv \
          src/StoreQueue.sv \
          src/Multiply.sv \
          src/Divide.sv \
          src/MMIO.sv \
          src/BranchSelector.sv \
          src/MemRTL.sv \
          src/MemRTL2W.sv \
          src/Top.sv \
          src/MemoryController.sv \
          src/RenameTable.sv \
          src/TagBuffer.sv \
          src/FPU.sv \
          src/FMul.sv \
          src/FDiv.sv \
          src/BranchTargetBuffer.sv \
          src/BranchPredictionTable.sv \
          src/ReturnStack.sv \
          src/TageTable.sv \
          src/TagePredictor.sv \
          src/LoadStoreUnit.sv \
          src/IFetchPipeline.sv \
          src/CSR.sv \
          src/TrapHandler.sv \
          src/Peripherals.sv \
          src/PageWalker.sv \
          src/LoadSelector.sv \
          src/LoadResultBuffer.sv \
          src/TLB.sv \
          src/BypassLSU.sv \
          src/TValSelect.sv \
          src/SoC.sv \
          src/TLBMissQueue.sv \
          src/ExternalAXISim.sv \
          src/CacheWriteInterface.sv \
          src/CacheReadInterface.sv \
          src/RegFileRTL.sv \
          src/BranchHandler.sv \
          src/StoreDataIQ.sv \
          src/StoreDataLoad.sv \
          src/StoreQueueBackend.sv \
          src/Scheduler.sv \
          src/ResultFlagsSplit.sv \
          src/InstrAligner.sv \
          src/RFReadMux.sv \
          src/CacheArbiter.sv \
          src/MemRTL1RW.sv \
          src/ExternalBus.sv \
          src/ExternalBusMem.sv \
          src/CacheLineManager.sv \
          src/DataPrefetch.sv \
          src/PrefetchPatternDetector.sv \
          src/PrefetchIssuer.sv \
          src/PrefetchExecutor.sv \
          hardfloat/addRecFN.v \
          hardfloat/compareRecFN.v \
          hardfloat/fNToRecFN.v \
          hardfloat/HardFloat_primitives.v \
          hardfloat/HardFloat_specialize.v \
          hardfloat/recFNToIN.v \
          hardfloat/recFNToFN.v \
          hardfloat/mulRecFN.v \
          hardfloat/HardFloat_rawFN.v \
          --single-unit \
          --std latest \
          --allow-use-before-declare \
          --relax-enum-conversions \
          --ignore-unknown-modules \
          --allow-toplevel-iface-ports \
          -Wno-explicit-static \
          -Wno-missing-top
        cwd: "$HAGENT_REPO_DIR"
        options:
          - name: top_synth
            description: "Optional top synthesis module for faster synthesis that avoids top elaboration"
            format: "--top-synthesis {value}:"
            default: ""
          - name: top
            description: "Top module for elaboration"
            format: "--top {value}:"
            default: "--top SoC"
